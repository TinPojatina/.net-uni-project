@model IEnumerable<LibraryManager.Models.Book>

<h2>All Books</h2>

@if (ViewBag.Message != null)
{
    <p class="text-muted">@ViewBag.Message</p>
}

@if (ViewBag.IsAdmin == true)
{
    <button class="btn btn-success mb-3" data-toggle="modal" data-target="#addBookModal">Add Book</button>
}

<table class="table table-bordered">
    <thead>
        <tr>
            <th>Title</th>
            <th>Author</th>
            <th>Published Year</th>
            <th>Available Copies</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var book in Model)
        {
            <tr>
                <td>@book.Title</td>
                <td>@book.Author</td>
                <td>@book.PublishedYear</td>
                <td>@book.AvailableCopies</td>
                <td>
                    @if (ViewBag.IsLoggedIn == true)
                    {
                        @if (ViewBag.IsAdmin == true)
                        {
                            <form method="post" asp-controller="Books" asp-action="DeleteBook" style="display:inline;">
                                <input type="hidden" name="id" value="@book.Id" />
                                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                            </form>
                        }
                        else
                        {
                            <button class="btn btn-primary btn-sm" onclick="showBorrowModal(@book.Id, @book.AvailableCopies)">
                                Borrow
                            </button>
                        }
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- Add Book Modal -->
<div class="modal fade" id="addBookModal" tabindex="-1" aria-labelledby="addBookModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addBookModalLabel">Add New Book</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form method="post" asp-controller="Books" asp-action="AddBook">
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" name="Title" class="form-control" required />
                    </div>
                    <div class="form-group">
                        <label>Author</label>
                        <input type="text" name="Author" class="form-control" required />
                    </div>
                    <div class="form-group">
                        <label>Published Year</label>
                        <input type="number" name="PublishedYear" class="form-control" required />
                    </div>
                    <div class="form-group">
                        <label>Available Copies</label>
                        <input type="number" name="AvailableCopies" class="form-control" required />
                    </div>
                    <button type="submit" class="btn btn-success">Add Book</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Borrow Book Modal -->
<div class="modal fade" id="borrowBookModal" tabindex="-1" aria-labelledby="borrowBookModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="borrowBookModalLabel">Confirm Borrowing</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to borrow this book?</p>
                <input type="hidden" id="borrowBookId" />
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmBorrow()">Confirm</button>
            </div>
        </div>
    </div>
</div>

<script>
    function showBorrowModal(bookId, availableCopies) {
        if (availableCopies <= 0) {
            alert("This book is currently unavailable.");
            return;
        }

        $("#borrowBookId").val(bookId);
        $("#borrowBookModal").modal("show");
    }

    function confirmBorrow() {
        var bookId = $("#borrowBookId").val();

        $.post("/Books/BorrowBookConfirm", { bookId: bookId }, function (response) {
            alert("Book borrowed successfully!");
            location.reload();
        }).fail(function () {
            alert("Failed to borrow book.");
        });

        $("#borrowBookModal").modal("hide");
    }
</script>
